# ComfyUI-Qwen3VL-DP 修改说明

## 最新修改 (2024年11月18日)

### 🌐 新增 ModelScope 模型支持
- ✅ **添加 ModelScope 下载支持**：支持从 ModelScope 下载社区模型
- ✅ **新增 4B 破限模型**：Huihui-Qwen3-VL-4B-Instruct-Abliterated
  - 来源：ModelScope (fireicewolf/Huihui-Qwen3-VL-4B-Instruct-abliterated)
  - 显存需求：6GB (FP16) / 3.5GB (8-bit) / 2GB (4-bit)
  - 基于 Qwen3-VL-4B 的 abliterated 版本
- ✅ **自动源选择**：根据模型配置自动选择 HuggingFace 或 ModelScope
- ✅ **依赖管理**：自动检测 ModelScope 库，未安装时提供友好提示

### 技术实现
```python
# 支持多源下载
if source == 'modelscope':
    from modelscope.hub.snapshot_download import snapshot_download
    # ModelScope 下载逻辑
else:
    from huggingface_hub import snapshot_download
    # HuggingFace 下载逻辑
```

---

## 修改日期
2024年11月18日

## 修改概述
对整个项目进行了大修正，主要涉及：
1. 随机种子控制和模型加载默认行为的优化
2. 主节点集成额外选项功能，支持更灵活的提示词增强
3. 新增 ModelScope 模型下载支持

## 详细修改内容

### 1. qwen3vl_node.py - Qwen3VL_Advanced 节点

#### 修改内容：
- ✅ **添加种子控制选项**：新增 `🎮 种子控制` 参数，可选"随机"或"固定"
  - 默认值：**随机**
  - 随机模式：每次运行使用不同的时间戳作为种子
  - 固定模式：使用用户指定的随机种子值

- ✅ **修改保持模型加载默认值**：
  - 原默认值：`True`
  - 新默认值：**`False`**
  - 目的：避免长时间占用显存

- ✅ **集成额外选项功能**：新增 `🎯 Qwen3VL额外选项` 可选输入
  - 可连接"Qwen3VL额外选项"节点
  - 自动将额外选项应用到提示词上
  - 支持预设提示词和自定义提示词
  - 无缝集成，不影响原有功能

#### 实现逻辑：
```python
# 根据种子控制设置随机种子
if 种子控制 == "固定":
    torch.manual_seed(随机种子)
else:
    torch.manual_seed(int(time.time()))

# 应用额外选项增强提示词
if qwen3vl_extra_options:
    from .qwen3vl_extra_options import Qwen3VL_ExtraOptions
    prompt_text = Qwen3VL_ExtraOptions.build_enhanced_prompt(prompt_text, qwen3vl_extra_options)
```

---

### 2. qwen3vl_node.py - Qwen3VL_Chat 节点

#### 修改内容：
- ✅ **修改保持模型加载默认值**：
  - 原默认值：`True`
  - 新默认值：**`False`**

- ℹ️ **种子控制**：该节点已经有种子控制功能，保持不变

- ✅ **集成额外选项功能**：新增 `🎯 Qwen3VL额外选项` 可选输入
  - 可连接"Qwen3VL额外选项"节点
  - 自动将额外选项应用到系统角色定义上
  - 增强AI助手的行为控制
  - 支持图像理解的细节控制

---

### 3. qwen3vl_batch_caption.py - 批量打标节点

#### 修改内容：
- ✅ **添加种子控制选项**：新增 `🎮 种子控制` 参数
  - 默认值：**随机**

- ✅ **智能覆盖逻辑**：
  - **随机模式**：自动强制覆盖已存在的txt文件（确保每次生成不同结果）
  - **固定模式**：遵循用户设置的"强制覆盖"选项

#### 实现逻辑：
```python
# 如果种子控制是随机，默认强制覆盖
if 种子控制 == "随机":
    强制覆盖 = True

# 根据种子控制设置随机种子
if 种子控制 == "固定":
    torch.manual_seed(随机种子)

# 处理每张图像
for idx, filename in enumerate(image_files):
    # 如果是随机模式，每次处理前都设置新的随机种子
    if 种子控制 == "随机":
        torch.manual_seed(int(time.time() * 1000) + idx)
```

---

### 4. qwen3vl_compare_caption.py - 对比打标节点

#### 修改内容：
- ✅ **添加种子控制选项**：新增 `🎮 种子控制` 参数
  - 默认值：**随机**

- ✅ **智能覆盖逻辑**：
  - **随机模式**：自动强制覆盖已存在的txt文件
  - **固定模式**：遵循用户设置的"强制覆盖"选项

#### 实现逻辑：
```python
# 如果种子控制是随机，默认强制覆盖
if 种子控制 == "随机":
    强制覆盖 = True

# 根据种子控制设置随机种子
if 种子控制 == "固定":
    torch.manual_seed(随机种子)

# 处理每对图像
for idx, (file_a, file_b) in enumerate(file_pairs):
    # 如果是随机模式，每次处理前都设置新的随机种子
    if 种子控制 == "随机":
        torch.manual_seed(int(time.time() * 1000) + idx)
```

---

## 功能特性总结

### 🎲 种子控制功能
1. **随机模式（默认）**：
   - 每次运行生成不同的结果
   - 批量处理时，每张图片使用不同的种子
   - 自动覆盖已存在的打标文件

2. **固定模式**：
   - 使用用户指定的种子值
   - 可重现相同的结果
   - 遵循用户的覆盖设置

### 🔄 模型加载优化
- 所有节点的"保持模型加载"默认改为 `False`
- 避免长时间占用显存
- 用户可根据需要手动开启

---

## 使用建议

### 适用场景

#### 使用随机模式（默认）：
- ✅ 需要多样化的描述结果
- ✅ 批量打标时希望每张图片有不同的描述风格
- ✅ 探索不同的描述可能性

#### 使用固定模式：
- ✅ 需要可重现的结果
- ✅ 调试和测试
- ✅ 对比不同参数的影响

---

## 技术实现细节

### 随机种子生成策略
- 基础随机种子：`int(time.time())`
- 批量处理增量：`int(time.time() * 1000) + idx`
- 确保每张图片的种子都不同

### 智能覆盖逻辑
```python
# 批量打标和对比打标节点
if 种子控制 == "随机":
    强制覆盖 = True  # 自动覆盖，确保生成新结果
```

---

## 兼容性说明
- ✅ 向后兼容：现有工作流不受影响
- ✅ 默认行为：所有节点默认使用随机模式
- ✅ 灵活配置：用户可随时切换到固定模式

---

## 测试建议
1. 测试随机模式：运行同一工作流多次，验证结果是否不同
2. 测试固定模式：使用相同种子运行多次，验证结果是否一致
3. 测试批量打标：验证随机模式下自动覆盖功能
4. 测试模型加载：验证默认不保持加载，显存正常释放

---

## 修改文件列表
- ✅ `qwen3vl_node.py`
- ✅ `qwen3vl_batch_caption.py`
- ✅ `qwen3vl_compare_caption.py`

---

## 🎯 额外选项集成功能详解

### 功能概述
在主节点（Qwen3VL_Advanced 和 Qwen3VL_Chat）上新增了 `🎯 Qwen3VL额外选项` 可选输入，允许用户连接"Qwen3VL额外选项"节点来增强提示词。

### 工作原理

#### 1. Qwen3VL_Advanced 节点
```
用户输入（预设提示词或自定义提示词）
    ↓
应用额外选项增强
    ↓
生成最终提示词
    ↓
发送给模型处理
```

**示例**：
- 基础提示词：`"详细描述这张图片"`
- 额外选项：启用"包含光照信息"、"包含相机角度"
- 最终提示词：
  ```
  详细描述这张图片
  
  请遵循以下额外要求：
  - 请描述图像的光照情况。
  - 请描述相机角度信息。
  ```

#### 2. Qwen3VL_Chat 节点
```
系统角色定义
    ↓
应用额外选项增强
    ↓
生成增强的系统角色
    ↓
用于对话生成
```

**示例**：
- 基础系统角色：`"你是一个专业、友好且乐于助人的AI助手。"`
- 额外选项：启用"包含艺术质量"、"包含构图信息"
- 增强后的系统角色：
  ```
  你是一个专业、友好且乐于助人的AI助手。
  
  请遵循以下额外要求：
  - 请评价图像的美学/艺术质量（从非常低到非常高）。
  - 请描述图像构图信息，如三分法、引导线、对称性等。
  ```

### 使用方法

1. **添加额外选项节点**：
   - 在工作流中添加"🍭大炮-Qwen3VL额外选项"节点
   - 配置需要的选项（如光照、相机角度、艺术质量等）

2. **连接到主节点**：
   - 将额外选项节点的输出连接到主节点的 `🎯 Qwen3VL额外选项` 输入

3. **正常使用**：
   - 选择预设提示词或输入自定义提示词
   - 额外选项会自动应用，无需手动修改提示词

### 优势特点

✅ **灵活性**：
- 可选连接，不影响原有工作流
- 支持预设提示词和自定义提示词
- 批量打标节点已有此功能，现在主节点也支持

✅ **模块化**：
- 额外选项独立配置
- 可重复使用同一个额外选项节点
- 便于管理和调整

✅ **智能集成**：
- 自动合并提示词
- 保持原有提示词的完整性
- 添加结构化的额外要求

✅ **向后兼容**：
- 不连接额外选项时，功能与原来完全相同
- 现有工作流无需修改

### 应用场景

#### 场景1：图像打标
```
主节点：Qwen3VL_Advanced
预设提示词：提示词风格 - 详细
额外选项：
  - 包含光照信息 ✓
  - 包含相机角度 ✓
  - 包含艺术质量 ✓
  
结果：生成包含光照、角度和艺术质量评价的详细描述
```

#### 场景2：智能对话
```
主节点：Qwen3VL_Chat
系统角色：专业的摄影分析助手
额外选项：
  - 包含相机详情 ✓
  - 包含构图信息 ✓
  - 不使用模糊语言 ✓
  
结果：AI助手会以专业摄影师的角度分析图像
```

#### 场景3：批量处理
```
主节点：Qwen3VL_Advanced
额外选项节点 → 连接到多个主节点
  
优势：一次配置，多处使用
```

---

## 备注
所有修改已完成并通过验证，可以直接使用。如有问题，请参考本文档或联系开发者。
